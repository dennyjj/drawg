name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Build and bundle
        run: make dist

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Compute SHA256
        id: sha
        run: echo "sha256=$(shasum -a 256 .build/release/Drawg.zip | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: .build/release/Drawg.zip
          generate_release_notes: true

      - name: Update Homebrew tap
        env:
          TAP_TOKEN: ${{ secrets.TAP_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          if [ -z "$TAP_TOKEN" ]; then
            echo "TAP_TOKEN not set, skipping tap update"
            echo "SHA256: $SHA256"
            echo "Version: $VERSION"
            exit 0
          fi
          git clone https://x-access-token:${TAP_TOKEN}@github.com/dennyjj/homebrew-drawg.git tap
          cd tap
          cat > Casks/drawg.rb << EOF
          cask "drawg" do
            version "$VERSION"
            sha256 "$SHA256"

            url "https://github.com/dennyjj/drawg/releases/download/v#{version}/Drawg.zip"
            name "Drawg"
            desc "Screenshot and annotation tool for macOS"
            homepage "https://github.com/dennyjj/drawg"

            app "Drawg.app"

            zap trash: [
              "~/.drawg",
            ]
          end
          EOF
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/drawg.rb
          git commit -m "Update drawg to $VERSION"
          git push
